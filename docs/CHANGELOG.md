# Changelog

## 2025-12-26 - Новый интерфейс отображения данных

### Добавлено

1. **Новый модуль `core/data_transform.py`**:
   - `pivot_to_wide_format()` - преобразование данных из длинного формата (date, category, amount) в широкий (категории × месяцы)
   - `add_forecast_columns()` - добавление трёх колонок для прогнозного месяца: Прогноз, Корректировки, Итого
   - `get_next_month_name()` - определение названия следующего месяца после последней даты в данных

2. **Обновлён модуль `core/io_historical.py`**:
   - Функция `load_history_from_file()` теперь поддерживает **два формата**:
     - Старый формат: длинный (date, category, amount) - по одной транзакции в строке
     - Новый формат: широкий (строки=статьи, столбцы=месяцы) - таблица cashflow
   - Автоматическое определение формата файла
   - Поддержка русских и английских названий месяцев

3. **Обновлён интерфейс `app.py`**:
   - После загрузки файла данные **сразу отображаются** в виде таблицы (статьи × месяцы)
   - Автоматически добавляется следующий месяц с тремя колонками:
     - **Прогноз** - рассчитывается AI или вводится вручную (редактируемая)
     - **Корректировки** - ручные правки пользователя (редактируемая)
     - **Итого** - автоматически рассчитывается как Прогноз + Корректировки (не редактируемая)
   - Исторические данные отображаются в режиме **только для чтения**
   - Добавлены итоговые метрики по прогнозному месяцу

### Изменено

- Исправлена опечатка в параметре функции `load_history_from_file()`: `fil_e_path_or_buffer` → `file_path_or_buffer`
- Упрощена логика работы с прогнозом: теперь таблица отображается сразу после загрузки, а не после нажатия кнопки
- Кнопка "Рассчитать прогноз" переименована в "Рассчитать прогноз с AI" для ясности

### Файлы для тестирования

- `data/sample_cashflow.csv` - пример файла в новом формате (9 статей × 10 месяцев)
- `test_interface.py` - скрипт для тестирования функций преобразования данных
- `test_load_cashflow.py` - скрипт для тестирования загрузки данных

### Примеры использования

#### Формат файла (широкий):
```csv
Статья,Янв,Фев,Мар,Апр
Выручка,850000,920000,880000,950000
Себестоимость,-340000,-368000,-352000,-380000
Аренда,-120000,-120000,-120000,-120000
```

#### Формат данных после загрузки (длинный):
```
date        category         amount
2025-01-01  Выручка          850000
2025-01-01  Себестоимость   -340000
2025-01-01  Аренда          -120000
```

### Workflow

1. Пользователь загружает файл (CSV или Excel)
2. Данные автоматически преобразуются в широкий формат и отображаются
3. Добавляется следующий месяц с колонками: Прогноз, Корректировки, Итого
4. Пользователь может:
   - Нажать "Рассчитать прогноз с AI" для автоматического заполнения
   - Вручную заполнить/откорректировать значения в колонках Прогноз и Корректировки
5. Колонка "Итого" автоматически пересчитывается
6. Сценарий сохраняется в БД

### Технические детали

- Используется `pandas.pivot_table()` для преобразования формата
- Названия месяцев переводятся с английского на русский
- Даты парсятся гибко: поддерживается формат `YYYY-MM`, короткие названия месяцев (Янв, Feb)
- При отсутствии явной даты используется текущий год
